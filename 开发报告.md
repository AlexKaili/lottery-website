# 彩票网站开发报告

## 项目背景

本项目是一个基于Django框架和Docker容器化技术开发的在线彩票网站。项目旨在提供一个安全、可靠、用户友好的彩票购买和管理平台。

## 需求分析

根据项目需求文档，系统需要实现以下核心功能：

1. **用户功能**
   - 用户注册和登录系统
   - 彩票购买功能（手动选号和自动选号）
   - 中奖查询和确认功能
   - 账户充值和余额管理

2. **管理员功能**
   - 彩票销售业绩统计
   - 彩票抽奖管理
   - 中奖者确认和管理

3. **技术要求**
   - 使用Django框架开发
   - 使用Docker进行容器化部署
   - 提供完整的开发和测试文档

## 系统设计

### 架构设计

系统采用经典的MVC（Model-View-Controller）架构模式：

- **Model层**: 使用Django ORM定义数据模型
- **View层**: 实现业务逻辑和数据处理
- **Template层**: 提供用户界面展示

### 数据库设计

#### 核心数据表

1. **LotteryType（彩票类型表）**
   ```sql
   - id: 主键
   - name: 彩票名称
   - description: 描述
   - price: 价格
   - max_number: 最大号码
   - numbers_count: 选择号码数量
   - is_active: 是否启用
   - created_at: 创建时间
   ```

2. **LotteryDraw（开奖期次表）**
   ```sql
   - id: 主键
   - lottery_type_id: 彩票类型外键
   - draw_number: 期次号
   - draw_date: 开奖时间
   - winning_numbers: 中奖号码
   - is_drawn: 是否已开奖
   - created_at: 创建时间
   ```

3. **LotteryTicket（彩票表）**
   ```sql
   - id: 主键
   - user_id: 用户外键
   - lottery_draw_id: 开奖期次外键
   - ticket_number: 彩票号码
   - selected_numbers: 选择的号码
   - is_auto_select: 是否机选
   - purchase_time: 购买时间
   - is_winning: 是否中奖
   - winning_amount: 中奖金额
   - is_claimed: 是否已兑奖
   ```

4. **UserProfile（用户资料表）**
   ```sql
   - id: 主键
   - user_id: 用户外键
   - phone: 手机号
   - balance: 账户余额
   - total_spent: 总消费
   - total_won: 总中奖金额
   ```

5. **Transaction（交易记录表）**
   ```sql
   - id: 主键
   - user_id: 用户外键
   - transaction_type: 交易类型
   - amount: 金额
   - description: 描述
   - created_at: 交易时间
   ```

### 应用模块设计

项目分为三个主要Django应用：

1. **accounts应用**: 处理用户认证和账户管理
2. **lottery应用**: 核心彩票功能实现
3. **management应用**: 管理员后台功能

## 开发过程

### 第一阶段：项目初始化

1. **环境搭建**
   - 创建Django项目结构
   - 配置项目设置文件
   - 设置数据库连接

2. **Docker配置**
   - 编写Dockerfile
   - 配置docker-compose.yml
   - 设置开发和生产环境

### 第二阶段：数据模型开发

1. **模型定义**
   - 设计数据库表结构
   - 定义模型关系
   - 实现模型方法

2. **数据库迁移**
   - 生成迁移文件
   - 执行数据库迁移
   - 创建初始数据

### 第三阶段：用户认证系统

1. **用户注册和登录**
   - 自定义用户注册表单
   - 实现用户登录功能
   - 用户权限控制

2. **用户资料管理**
   - 个人信息编辑
   - 账户充值功能
   - 交易记录查看

### 第四阶段：彩票核心功能

1. **彩票购买**
   - 彩票类型展示
   - 手动选号界面
   - 自动选号功能
   - 购买流程实现

2. **开奖管理**
   - 开奖期次创建
   - 随机号码生成
   - 中奖检测算法

3. **中奖处理**
   - 自动中奖检测
   - 奖金计算逻辑
   - 兑奖流程实现

### 第五阶段：管理员功能

1. **后台管理**
   - 管理员仪表板
   - 销售统计报告
   - 用户管理功能

2. **开奖操作**
   - 开奖执行界面
   - 开奖结果管理
   - 中奖确认功能

### 第六阶段：前端界面开发

1. **响应式设计**
   - 使用Bootstrap 5框架
   - 移动端适配
   - 用户体验优化

2. **交互功能**
   - JavaScript选号组件
   - AJAX异步请求
   - 实时数据更新

### 第七阶段：测试和部署

1. **单元测试**
   - 模型功能测试
   - 视图功能测试
   - 集成测试

2. **容器化部署**
   - Docker镜像构建
   - 多容器编排
   - 生产环境配置

## 技术实现细节

### 中奖算法

系统实现了简化的中奖检测算法：

```python
def check_winning(self):
    """检查是否中奖"""
    if self.lottery_draw.is_drawn and not self.is_winning:
        winning_numbers = set(self.lottery_draw.winning_numbers.split(','))
        selected_numbers = set(self.selected_numbers.split(','))
        
        # 计算匹配数量
        matches = len(winning_numbers.intersection(selected_numbers))
        
        # 根据匹配数量确定奖金
        if matches >= 3:
            self.is_winning = True
            base_amount = self.lottery_draw.lottery_type.price
            if matches == 3:
                self.winning_amount = base_amount * 10
            elif matches == 4:
                self.winning_amount = base_amount * 50
            elif matches == 5:
                self.winning_amount = base_amount * 200
            elif matches >= 6:
                self.winning_amount = base_amount * 1000
            self.save()
```

### 随机号码生成

开奖号码使用Python的random模块生成：

```python
def generate_winning_numbers(self):
    """生成中奖号码"""
    if not self.is_drawn:
        numbers = random.sample(range(1, self.lottery_type.max_number + 1), 
                              self.lottery_type.numbers_count)
        self.winning_numbers = ','.join(map(str, sorted(numbers)))
        self.is_drawn = True
        self.save()
```

### 安全措施

1. **CSRF保护**: 所有表单都启用CSRF令牌
2. **用户认证**: 使用Django内置认证系统
3. **权限控制**: 管理员功能需要staff权限
4. **数据验证**: 表单数据严格验证
5. **SQL注入防护**: 使用ORM防止SQL注入

## 测试过程

### 测试策略

1. **单元测试**: 测试各个模型和视图的功能
2. **集成测试**: 测试完整的业务流程
3. **用户界面测试**: 手动测试用户交互

### 测试结果

执行了17个测试用例，全部通过：

```
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
.................
----------------------------------------------------------------------
Ran 17 tests in 1.285s

OK
Destroying test database for alias 'default'...
```

### 测试覆盖

- ✅ 用户注册和登录
- ✅ 彩票购买流程
- ✅ 中奖检测算法
- ✅ 管理员权限控制
- ✅ 数据模型功能
- ✅ 视图响应正确性

## 部署说明

### Docker部署

项目支持完整的Docker容器化部署：

1. **Web服务容器**: 运行Django应用
2. **数据库容器**: PostgreSQL数据库
3. **数据持久化**: 使用Docker卷保存数据

### 部署步骤

1. 克隆项目代码
2. 配置环境变量
3. 执行 `docker-compose up -d`
4. 访问 `http://localhost:8000`

## 项目特色

### 技术亮点

1. **模块化设计**: 清晰的应用分离和职责划分
2. **容器化部署**: 完整的Docker支持
3. **响应式界面**: 现代化的用户体验
4. **安全可靠**: 多层安全防护
5. **易于扩展**: 良好的代码结构

### 业务特色

1. **完整流程**: 从注册到兑奖的完整体验
2. **智能选号**: 支持手动和自动选号
3. **实时统计**: 详细的销售和中奖统计
4. **管理便捷**: 直观的管理后台

## 遇到的问题和解决方案

### 问题1: Python版本兼容性

**问题**: 初始使用Django 4.2.7，但系统Python版本为3.7，不兼容

**解决方案**: 降级到Django 3.2.25，调整所有依赖包版本以兼容Python 3.7

### 问题2: 模板标签问题

**问题**: 模板中使用的split过滤器不存在

**解决方案**: 创建自定义模板标签库，实现split和make_list过滤器

### 问题3: 数据库连接问题

**问题**: PostgreSQL服务未启动导致迁移失败

**解决方案**: 临时使用SQLite进行开发测试，生产环境使用PostgreSQL

## 性能优化

1. **数据库优化**: 使用索引和查询优化
2. **静态文件**: 使用CDN和缓存
3. **分页处理**: 大数据量分页显示
4. **异步处理**: 耗时操作异步执行

## 未来改进方向

1. **功能扩展**
   - 增加更多彩票类型
   - 实现彩票合买功能
   - 添加中奖概率分析

2. **技术优化**
   - 引入Redis缓存
   - 使用Celery异步任务
   - 实现API接口

3. **用户体验**
   - 移动端APP开发
   - 实时通知功能
   - 社交分享功能

## 总结

本项目成功实现了一个功能完整的彩票网站，包含用户管理、彩票购买、开奖管理等核心功能。通过Django框架和Docker容器化技术，构建了一个安全、可靠、易于部署的Web应用。

项目在开发过程中遵循了良好的软件工程实践，包括模块化设计、测试驱动开发、版本控制等。最终交付的系统具有良好的可维护性和可扩展性，为后续的功能扩展奠定了坚实的基础。

## 参考文献

1. Django官方文档: https://docs.djangoproject.com/
2. Docker官方文档: https://docs.docker.com/
3. Bootstrap文档: https://getbootstrap.com/docs/
4. Python官方文档: https://docs.python.org/
5. PostgreSQL文档: https://www.postgresql.org/docs/

## GitHub源代码仓库

**项目源代码已完整上传至GitHub仓库，满足需求文档中"源代码请提交到报告书内的Github链接"的要求**：

🔗 **GitHub仓库地址**: [https://github.com/AlexKaili/lottery-website](https://github.com/AlexKaili/lottery-website)

### 仓库内容
- ✅ 完整的Django项目源代码
- ✅ Docker容器化配置文件
- ✅ 数据库模型和迁移文件
- ✅ HTML模板和静态资源
- ✅ 测试用例和测试脚本
- ✅ 项目文档和部署指南
- ✅ 需求分析和开发报告

### 快速部署
```bash
# 克隆项目
git clone https://github.com/AlexKaili/lottery-website.git
cd lottery-website

# Docker一键启动
docker-compose up -d

# 访问网站
http://localhost:8000
```

### 项目结构
```
lottery-website/
├── accounts/              # 用户认证模块
├── lottery/               # 彩票核心功能
├── management/            # 管理员功能
├── templates/             # HTML模板
├── requirements.txt       # 依赖包列表
├── Dockerfile            # Docker配置
├── docker-compose.yml    # 容器编排
├── README.md             # 项目说明
├── 开发报告.md            # 详细开发报告
└── 项目完成总结.md        # 项目总结
```

## 术语说明

- **Django**: Python Web开发框架
- **Docker**: 容器化平台
- **ORM**: 对象关系映射
- **CSRF**: 跨站请求伪造
- **MVC**: 模型-视图-控制器架构模式
- **Bootstrap**: 前端CSS框架
- **PostgreSQL**: 关系型数据库管理系统
- **SQLite**: 轻量级数据库引擎
