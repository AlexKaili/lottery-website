{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}복권 구매 - {{ lottery_type.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>{{ lottery_type.name }} 구매</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>복권 설명：</strong>{{ lottery_type.description }}<br>
                    <strong>번호 선택 규칙：</strong>1-{{ lottery_type.max_number }} 중에서 {{ lottery_type.numbers_count }}개 번호 선택<br>
                    <strong>가격：</strong>₩{{ lottery_type.price }}
                </div>

                <form method="post" id="purchaseForm">
                    {% csrf_token %}
                    {{ form|crispy }}
                    
                    <!-- 수동 번호 선택 영역 -->
                    <div id="manualSelection" style="display: none;">
                        <h5>수동 번호 선택</h5>
                        <div class="number-grid mb-3">
                            {% for i in "123456789012345678901234567890123456789012345678901234567890"|make_list %}
                                {% if forloop.counter <= lottery_type.max_number %}
                                <button type="button" class="btn btn-outline-primary number-btn m-1" data-number="{{ forloop.counter }}">
                                    {{ forloop.counter }}
                                </button>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="alert alert-warning">
                            <small>{{ lottery_type.numbers_count }}개 번호를 선택해주세요. 선택됨：<span id="selectedCount">0</span>개</small>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            구매 확인 (₩{{ lottery_type.price }})
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>계정 정보</h5>
            </div>
            <div class="card-body">
                <p><strong>현재 잔액：</strong>￥{{ user_profile.balance }}</p>
                <p><strong>구매 금액：</strong>￥{{ lottery_type.price }}</p>
                {% if user_profile.balance < lottery_type.price %}
                <div class="alert alert-danger">
                    잔액이 부족합니다! 먼저 충전해주세요.
                </div>
                <a href="{% url 'accounts:recharge' %}" class="btn btn-primary">지금 충전하기</a>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>현재 회차</h5>
            </div>
            <div class="card-body">
                <p><strong>회차 번호:</strong>{{ current_draw.draw_number }}</p>
                <p><strong>추첨 시간:</strong>{{ current_draw.draw_date|date:"Y-m-d H:i" }}</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const autoSelectCheckbox = document.getElementById('id_is_auto_select');
    const manualSelection = document.getElementById('manualSelection');
    const selectedNumbersInput = document.getElementById('id_selected_numbers');
    const numberButtons = document.querySelectorAll('.number-btn');
    const selectedCountSpan = document.getElementById('selectedCount');
    const maxNumbers = {{ lottery_type.numbers_count }};
    let selectedNumbers = [];

    // 번호 선택 모드 전환
    autoSelectCheckbox.addEventListener('change', function() {
        if (this.checked) {
            manualSelection.style.display = 'none';
            selectedNumbersInput.value = '';
        } else {
            manualSelection.style.display = 'block';
        }
    });

    // 수동 번호 선택
    numberButtons.forEach(button => {
        button.addEventListener('click', function() {
            const number = parseInt(this.dataset.number);

            if (selectedNumbers.includes(number)) {
                // 선택 취소
                selectedNumbers = selectedNumbers.filter(n => n !== number);
                this.classList.remove('btn-primary');
                this.classList.add('btn-outline-primary');
            } else if (selectedNumbers.length < maxNumbers) {
                // 선택 추가
                selectedNumbers.push(number);
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-primary');
            }

            selectedNumbers.sort((a, b) => a - b);
            selectedNumbersInput.value = selectedNumbers.join(',');
            selectedCountSpan.textContent = selectedNumbers.length;
        });
    });

    // 초기 상태
    if (autoSelectCheckbox.checked) {
        manualSelection.style.display = 'none';
    }
});
</script>
{% endblock %}
